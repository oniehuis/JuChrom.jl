<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Scan timing · JuChrom.jl</title><meta name="title" content="Scan timing · JuChrom.jl"/><meta property="og:title" content="Scan timing · JuChrom.jl"/><meta property="twitter:title" content="Scan timing · JuChrom.jl"/><meta name="description" content="Documentation for JuChrom.jl."/><meta property="og:description" content="Documentation for JuChrom.jl."/><meta property="twitter:description" content="Documentation for JuChrom.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="JuChrom.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">JuChrom.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">Core containers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../containers/">Design overview</a></li><li><a class="tocitem" href="../scans/">Scans</a></li><li><a class="tocitem" href="../scanseries/">Scan series</a></li><li><a class="tocitem" href="../scanmatrices/">Scan matrices</a></li></ul></li><li><a class="tocitem" href="../units_quantities/">Units and Quantities</a></li><li><input class="collapse-toggle" id="menuitem-2-3" type="checkbox"/><label class="tocitem" for="menuitem-2-3"><span class="docs-label">Loaders</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../loaderapi/">Loader API</a></li><li><a class="tocitem" href="../agilentfid/">Agilent FID</a></li><li><a class="tocitem" href="../chemstationms/">Agilent ChemStation MS</a></li><li><a class="tocitem" href="../masshunterms/">Agilent MassHunter MS</a></li><li><a class="tocitem" href="../shimadzums/">Shimadzu MS</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox" checked/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Data processing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../alignment/">Alignment</a></li><li><a class="tocitem" href="../baseline/">Baseline</a></li><li><input class="collapse-toggle" id="menuitem-2-4-3" type="checkbox"/><label class="tocitem" for="menuitem-2-4-3"><span class="docs-label">Binning and Gridding</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../mz_binning/">m/z binning</a></li><li><a class="tocitem" href="../binning_gridding/">Retention binning and gridding</a></li></ul></li><li><a class="tocitem" href="../deconvolution/">Deconvolution</a></li><li><a class="tocitem" href="../convert/">Format conversion</a></li><li><input class="collapse-toggle" id="menuitem-2-4-6" type="checkbox"/><label class="tocitem" for="menuitem-2-4-6"><span class="docs-label">Retention mapping</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../mapping_overview/">Overview</a></li><li><a class="tocitem" href="../mapping_tools/">Mapping tools</a></li></ul></li><li class="is-active"><a class="tocitem" href>Scan timing</a><ul class="internal"><li><a class="tocitem" href="#Background"><span>Background</span></a></li><li><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#Scan-timing-function"><span>Scan timing function</span></a></li></ul></li><li><a class="tocitem" href="../transformation/">Transformation</a></li><li><a class="tocitem" href="../transform/">Trimming and Filtering</a></li><li><a class="tocitem" href="../quadvar_model/">Variance modeling</a></li></ul></li></ul></li><li><span class="tocitem">Internals</span><ul><li><a class="tocitem" href="../../internals/deconvolution/">Deconvolution</a></li><li><a class="tocitem" href="../../internals/transform/">Transform</a></li><li><a class="tocitem" href="../../internals/utils/">Utilities</a></li></ul></li><li><a class="tocitem" href="../register/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li><a class="is-disabled">Data processing</a></li><li class="is-active"><a href>Scan timing</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Scan timing</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/oniehuis/JuChrom.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/oniehuis/JuChrom.jl/blob/main/docs/src/man/scan_timing.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Scan-timing"><a class="docs-heading-anchor" href="#Scan-timing">Scan timing</a><a id="Scan-timing-1"></a><a class="docs-heading-anchor-permalink" href="#Scan-timing" title="Permalink"></a></h1><h2 id="Background"><a class="docs-heading-anchor" href="#Background">Background</a><a id="Background-1"></a><a class="docs-heading-anchor-permalink" href="#Background" title="Permalink"></a></h2><p>In gas chromatography–mass spectrometry (GC–MS), a scan-level retention coordinate is not, in general, the coordinate at which every ion in that scan is acquired. Each scan spans a finite retention interval during which ions are sampled sequentially according to the instrument’s acquisition scheme. Consequently, the ion-specific retention coordinate depends on how the scan interval is referenced and how sampling is scheduled within it.</p><p>Instrument software and data formats typically associate a single retention value with each scan. However, that value may represent the start, midpoint, or end of the scan interval, depending on vendor conventions, acquisition mode, and export settings. Within a scan, ions are acquired in a defined order (e.g., ascending or descending m/z), and each ion is assigned a dwell interval whose duration may be constant across ions or vary with instrument settings. As a result, different ions are sampled at systematically different retention coordinates within the same scan.</p><p>For many downstream analyses—such as accurate peak-shape reconstruction and deconvolution— treating all ions in a scan as if they were measured at the same retention coordinate introduces avoidable systematic error. This is particularly relevant when scan durations are non-negligible relative to chromatographic peak widths or when dwell times are heterogeneous.</p><p>Within a single run, ion‑trace alignment is governed by three factors: (i) the within‑scan timing of each ion set by the dwell schedule and acquisition order, (ii) which point the instrument reports for each scan (start/middle/end), and (iii) which point within each dwell interval you treat as the ion’s timestamp (start/middle/end). The within‑scan timing is the primary source of systematic offsets between ions; the scan‑level and dwell‑level reference choices control how those offsets are anchored on the reported scan time. When  comparing runs acquired on the same instrument with the same method, the absolute scan‑time  reference usually cancels out because it is consistent across runs. It becomes critical  primarily when comparing data from different instruments or acquisition schemes with  different timing conventions, where absolute scan times are not directly comparable anyway.</p><p>Practically, this means you mainly need to know whether dwell allocation is homogeneous or heterogeneous (and the dwell times if heterogeneous), and the acquisition direction (ascending or descending m/z). The example below shows how the acquisition direction can be inferred empirically. With these considerations in mind, the mapping from scan‑level time to an ion‑specific time reduces to combining a small set of explicit inputs:</p><ul><li>the reference point associated with the scan‑level retention value (often set to :start  in practice when the true reference is unknown),</li><li>the total scan interval,</li><li>the dwell allocation across ions and the acquisition order within the scan, and</li><li>the desired reference point within each ion’s dwell interval (typically :middle).</li></ul><p>The JuChrom function <a href="#JuChrom.mzretention"><code>mzretention</code></a> formalizes this mapping. Given a scan-level retention coordinate and a description of the within-scan sampling scheme, it computes the effective retention coordinate at which a specific ion is sampled. This enables consistent, reproducible ion-level retention calculations across different acquisition configurations and data representations.</p><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><pre><code class="language-julia hljs"># Load JuChrom, the plotting backend, and the Agilent ChemStation MS loader
using JuChrom
using JuChrom.ChemStationMSLoader

# Load CairoMakie for plotting and Statistics for calculating the mean
using CairoMakie, Statistics

# Load an example Agilent ChemStation GC-MS run
file = joinpath(JuChrom.agilent, &quot;C7-C40_ChemStationMS.D&quot;, &quot;data.ms&quot;)
mss = load(ChemStationMS(file; mode=:ms))

# Trim scans to the RT interval (20.25–20.40 minutes) containing the n‑nonacosane peak
retentiontrim!(mss, start=20.25u&quot;minute&quot;, stop=20.4u&quot;minute&quot;)

# Integer-bin m/z values and convert to a MassScanMatrix
msm = mscanmatrix(binmzvalues(mss, validmzvalues=29:562))

# Plot the chromatograms of m/z 57, 239, and 408 using scan-level retentions
fig₁ = Figure(; size=(1000, 350))
ax₁ = Axis(fig₁[1,1],
           title=&quot;Selected ion chromatograms using scan-level retentions&quot;,
           ylabel=&quot;Intensity [no unit]&quot;,
           xlabel=&quot;Retention [minute]&quot;)

for mz in [57, 239, 408]
    i = mzindex(msm, mz)                        # m/z index in the binned list
    ints = vec(rawintensities(msm)[:, i])       # intensity trace for that m/z
    lines!(ax₁,
           rawretentions(msm, unit=u&quot;minute&quot;),
           ints / sum(ints),                    # normalize to a comparable scale
           label = &quot;m/z = $(mz)&quot;)
end
axislegend(ax₁; position=:rt)
save(&quot;xic.svg&quot;, fig₁)
nothing</code></pre><p><img src="../xic.svg" alt/></p><p>From the three traces, the peaks at higher m/z appear shifted to slightly later retention times, consistent with a <strong>descending</strong> m/z acquisition order. In a descending scan, higher  m/z ions sample a moving peak earlier within each scan than lower m/z ions for the same  scan‑level time. Points on the left slope are therefore sampled earlier by higher m/z,  whereas on the right slope the opposite holds. The net effect is a modest right‑shift of  high‑m/z peaks relative to low‑m/z peaks. While Agilent GC–MS instruments are known to  acquire in descending order, plotting prominent ions with widely separated m/z values allows  the acquisition order to be inferred empirically when it is not known <em>a priori</em>. We next  use this information to correct for the intra‑scan time shift and align the chromatographic  traces.</p><pre><code class="language-julia hljs"># Plot the chromatograms of m/z 57, 239, and 408 using shifted retentions
fig₂ = Figure(; size=(1000, 350))
ax₂ = Axis(fig₂[1,1], title=&quot;Selected ion chromatograms using shifted retentions&quot;,
                      ylabel=&quot;Intensity [no unit]&quot;,
                      xlabel=&quot;Retention [minute]&quot;)

rawrts = rawretentions(msm, unit=u&quot;minute&quot;)
rawscanduration = mean(diff(rawrts))
for mz in [57, 239, 408]
    i = mzindex(msm, mz)
    rts_corrected =
        mzretention.(rawrts;
                     mzindex=i,
                     mzcount=mzcount(msm),
                     dwell=:homogeneous,
                     order=:descending,
                     scan_interval=rawscanduration,
                     retention_ref=:end,
                     dwell_ref=:middle)

    ints = vec(rawintensities(msm)[:, i])
    lines!(ax₂,
           rts_corrected,
           ints / sum(ints),
           label = &quot;m/z = $(mz)&quot;)
end
axislegend(ax₂; position=:rt)
save(&quot;xic_shifted.svg&quot;, fig₂)
nothing</code></pre><p><img src="../xic_shifted.svg" alt/></p><p>As you can see, the three traces are now much better aligned and together provide a far more  reliable estimate of the peak shape than any single trace alone. Properly aligned ion traces  are therefore a prerequisite for accurate peak‑shape reconstruction in the context of <a href="../deconvolution/">Deconvolution</a>, including accurate peak‑mode inference.</p><h2 id="Scan-timing-function"><a class="docs-heading-anchor" href="#Scan-timing-function">Scan timing function</a><a id="Scan-timing-function-1"></a><a class="docs-heading-anchor-permalink" href="#Scan-timing-function" title="Permalink"></a></h2><article><details class="docstring" open="true"><summary id="JuChrom.mzretention"><a class="docstring-binding" href="#JuChrom.mzretention"><code>JuChrom.mzretention</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">mzretention(
    retention::Union{Real, Unitful.Quantity};
    mzindex::Union{Int, Nothing}=nothing,
    mzvalue::Union{Real, Unitful.Quantity, Nothing}=nothing,
    mzvalues::Union{AbstractVector{&lt;:Union{Real, Unitful.Quantity}}, Nothing}=nothing,
    retention_ref::Symbol=:start,
    dwell_ref::Symbol=:middle,
    dwell::Symbol=:homogeneous,
    dwell_retention::Union{Real, Unitful.Quantity, Nothing}=nothing,
    scan_interval::Union{Real, Unitful.Quantity, Nothing}=nothing,
    dwell_retentions::Union{AbstractVector{&lt;:Union{Real, Unitful.Quantity}}, Nothing}=nothing,
    mzcount::Union{Int, Nothing}=nothing,
    order::Symbol=:ascending,
    validate_span::Bool=true
)</code></pre><p>Return the retention coordinate at which a specific m/z (or m/z index) is sampled within a  scan.</p><p>A scan spans a finite retention interval of width <code>scan_span</code>. The reported scan-level  <code>retention</code> typically refers to a particular reference point of that interval  (start/middle/end). Within that interval, m/z values are sampled sequentially, each over a  dwell interval. This function maps the scan-level <code>retention</code> to the retention coordinate  associated with one specific m/z dwell interval, using how <code>retention</code> is referenced within  the scan interval (<code>retention_ref</code>), the dwell allocation model (<code>dwell</code>,  <code>dwell_retention</code>/<code>scan_interval</code> or <code>dwell_retentions</code>), the m/z acquisition order  (<code>order</code>), and which point within the dwell interval to return (<code>dwell_ref</code>).</p><p><code>retention</code> and all dwell/interval inputs may be unitless (<code>Real</code>) or unitful  (<code>Unitful.Quantity</code>), as long as they are mutually compatible for addition and subtraction.  The target ion is specified either by index (<code>mzindex</code>) or by value (<code>mzvalue</code> together with  <code>mzvalues</code>), in which case the index is found via <code>findfirst(==(mzvalue), mzvalues)</code>. The  resolved index refers to the order in which <code>mzvalues</code> or <code>dwell_retentions</code> are provided;  when the instrument acquires in descending m/z order but the vectors are stored in ascending  order, set <code>order = :descending</code> to obtain the correct within-scan position.</p><p>Keyword arguments are interpreted as follows. <code>mzindex</code> is a 1-based index of the target m/z  in the provided list and is inferred from <code>mzvalue</code> and <code>mzvalues</code> when omitted. <code>mzcount</code>  is the total number of m/z values sampled in the scan and is inferred from  <code>dwell_retentions</code> for heterogeneous dwell or from <code>mzvalues</code> otherwise; if neither is  available, it must be provided explicitly. For homogeneous dwell, you must supply  <code>dwell_retention</code> or <code>scan_interval</code> (from which <code>dwell_retention</code> is derived), and  consistency is checked when both are provided. For heterogeneous dwell, <code>dwell_retentions</code>  must be provided, must have length <code>mzcount</code>, and must be strictly positive; if  <code>scan_interval</code> is provided and <code>validate_span</code> is <code>true</code>, the function checks that  <code>sum(dwell_retentions) ≈ scan_interval</code> within a relative tolerance of <code>1e-6</code>.  The scan-level reference is controlled by <code>retention_ref</code> (<code>:start</code>, <code>:middle</code>, or <code>:end</code>),  and the dwell reference is controlled by <code>dwell_ref</code> (<code>:start</code>, <code>:middle</code>, or <code>:end</code>),  corresponding to the start, midpoint, or end of the target dwell interval.</p><p>The scan start is computed from the scan-level reference as <code>scan_start=retention</code> for <code>retention_ref==:start</code>, <code>scan_start=retention - scan_span / 2</code> for  <code>retention_ref==:middle</code>, and <code>scan_start=retention - scan_span</code> for <code>retention_ref==:end</code>.</p><p>The returned value is</p><p class="math-container">\[scan\_start + \sum_{j&lt;k} \delta_j + \phi(\delta_k)\]</p><p>where <code>k</code> is the acquisition-order index, <code>δ_j</code> are dwell widths in acquisition order,  and <code>φ</code> is the offset chosen by <code>dwell_ref</code> (<code>0</code>, <code>δ/2</code>, or <code>δ</code>).</p><p><strong>Examples</strong></p><pre><code class="language-julia-repl hljs">julia&gt; # Homogeneous dwell times with mz target selected by index:

julia&gt; r₁ = mzretention(12.345u&quot;minute&quot;;       # scan-level retention
                       mzindex=3,              # return acquisition time of 3rd ion
                       mzcount=10,             # 10 ions
                       dwell=:homogeneous,     # homogeneously dwelled
                       order=:descending,      # in descending m/z order
                       scan_interval=50u&quot;ms&quot;,  # across 50 ms
                       retention_ref=:start,   # scantime represents scan start
                       dwell_ref=:middle);     # return acquisition time at dwell midpoint

julia&gt; r₁ ≈ 12.345625u&quot;minute&quot;
true

julia&gt; # Heterogeneous dwell times with mz target selected by value:

julia&gt; mzvals = [43, 57, 71, 73, 77]u&quot;Th&quot;; 

julia&gt; dw = [0.002, 0.002, 0.003, 0.004, 0.002]u&quot;s&quot;;

julia&gt; r₂ = mzretention(100.0u&quot;s&quot;;             # scan-level retention
                        mzvalue=73u&quot;Th&quot;,       # return acquisition time of m/z 73 Thomson
                        mzvalues=mzvals,       # vector with 5 ions
                        dwell=:heterogeneous,  # heterogeneously dwelled
                        order=:descending,     # in descending m/z order
                        dwell_retentions=dw,   # dwell times per ion
                        retention_ref=:start,  # scantime represents scan start
                        dwell_ref=:middle);    # return acquisition time at dwell midpoint
        

julia&gt; r₂ ≈ 100.004u&quot;s&quot;
true

julia&gt; r₃ = mzretention.([100.0, 110.0]u&quot;s&quot;;  # dot form broadcasts over the retentions
                         mzvalue=73u&quot;Th&quot;,
                         mzvalues=mzvals,
                         dwell=:heterogeneous,
                         order=:descending,
                         dwell_retentions=dw,
                         retention_ref=:start,
                         dwell_ref=:middle);

julia&gt; r₃ ≈ [100.004, 110.004]u&quot;s&quot;
true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/oniehuis/JuChrom.jl/blob/b2b4748b44394ea132ac697e177a86207b1dd34f/src/core/scan_timing/mz_retention.jl#L1-L110">source</a></section></details></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../mapping_tools/">« Mapping tools</a><a class="docs-footer-nextpage" href="../transformation/">Transformation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Sunday 25 January 2026 19:51">Sunday 25 January 2026</span>. Using Julia version 1.12.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
